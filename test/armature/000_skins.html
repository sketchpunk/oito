<!DOCTYPE html><html><head><title></title></head><body><script type="module">
    
import Starter, { THREE }   from "../_lib/threejs/Starter.js";
import PointsMesh           from "../_lib/threejs/PointsMesh.js";
import Gltf2Util            from '../_lib/threejs/Gltf2Util.js';

import { Armature, SkinMTX, SkinDQ }    from '../../dist/armature.js';
import { Vec3, Quat, Mat4, Transform }  from "../../dist/core.js";
import Gltf2                            from "../../dist/parsers/Gltf2.js";

import SkinMTXMaterial      from './lib/SkinMTXMaterial.js';
import SkinDQMaterial       from './lib/SkinDQMaterial.js';
import BoneViewMaterial     from './lib/BoneViewMaterial.js';
import BoneViewMesh         from './lib/BoneViewMesh.js';

let App, gArm, gMesh;

let pnt;

window.addEventListener( "load", async _=>{
    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    App = new Starter( { webgl2:true, grid:true } );
    App.set_camera( 0, 20, 4, [0,0.8,0] ).render();

    //pnt = new PointsMesh( 100 );
    //App.add( pnt.mesh );

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    const gltf = await Gltf2.fetch( '../_res/models/nabba/nabba.gltf' );
    //const gltf = await Gltf2.fetch( '../_res/models/jinx/jinx.gltf' );
    //const gltf = await Gltf2.fetch( '../_res/models/tina/tina.gltf' );
    //const gltf = await Gltf2.fetch( '../_res/models/tyranitar/Tyranitar.gltf' );
    if( !gltf ){ console.log( 'Error loading GLTF' ); return; }

    //--------------------------------
    // Setup Armature
    const arm  = new Armature();
    for( let j of gltf.getSkin().joints ){
        arm.addBone( j.name, j.parentIndex, j.rotation, j.position, j.scale );
    }

    //arm.getBone( 'Head' ).len = 0.2;

    //--------------------------------
    // Setup Skinning

    /* Use Matrix Skinning */
    arm.bind( SkinMTX, 0.07 ); 
    const mat    = SkinMTXMaterial( 'cyan', arm.getSkinOffsets()[0] ); 

    /* Use Dual Quaternion Skinning  
    arm.bind( SkinDQ, 0.07 ); 
    const offset = arm.getSkinOffsets();
    const mat    = SkinDQMaterial( 'cyan', offset[0], offset[1] );*/

    //--------------------------------
    // Load Mesh
    const mesh  = Gltf2Util.loadMesh( gltf, null, mat );
    //mesh.scale.set( 0.05, 0.05, 0.05 );
    App.add( mesh );

    //--------------------------------
    // Visualize the Bones
    const boneView = new BoneViewMesh( arm );
    boneView.position.x = 1.0;
    App.add( boneView );

    //--------------------------------
    // Pose Model  
    //const glTPose = gltf.getPose();
    //console.log( glTPose );
   
    const pose  = arm.newPose();
    //pose.fromGLTF2( glTPose );
    /*pose
        .rotLocal( 'Hips', 20 ).moveLocal( 'Hips', [0,0.3,0] )
        .rotLocal( 'Spine1', -20 )
        .rotLocal( 'Spine2', -20 )
        .rotLocal( 'Spine3', -10 )
        .rotLocal( 'Neck', 15 )
        .rotLocal( 'Head', 20 ).rotLocal( 'Head', 40, 'y' )

        .rotLocal( 'Thigh_R', 80 ).rotLocal( 'Thigh_R', 8, 'z' )
        .rotLocal( 'Shin_R', -100 )
        .rotLocal( 'Foot_R', -30 )
        .rotLocal( 'Thigh_L', 30 ).rotLocal( 'Thigh_L', -8, 'z' )
        .rotLocal( 'Shin_L', -20 )
        .rotLocal( 'Foot_L', -40 )

        .rotLocal( 'UpperArm_L', 30 )
        .rotLocal( 'ForeArm_L', -40 )
        .rotLocal( 'UpperArm_R', 30 )
        .rotLocal( 'ForeArm_R', -40 )

        .sclLocal( 'Head', 1.3 )
        .sclLocal( 'Foot_L', 1.5 )
    ;
    */

    //--------------------------------
    pose.updateWorld();
    arm.updateSkinFromPose( pose );
    boneView.updateFromPose( pose );
});

</script></body></html>