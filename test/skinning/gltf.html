<!DOCTYPE html><html><head><title></title></head><body><script type="module">
    
import Starter, { THREE }  from "../lib/starter.js";
import Gltf                from "../../dist/misc/Gltf2.js";

let App;

window.addEventListener( "load", async _=>{
    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    App = new Starter( { webgl2:true, grid:true } );
    App.set_camera( 0, 20, 3, [0,0.8,1] ).render();

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Asset Loading
    let gltf    = await Gltf.fetch( './Vegeta.gltf' );
    let skin    = gltf.getSkin();   // First Available Skin
    let tfMesh  = gltf.getMesh();   // First Available Mesh
    let tfPrim  = tfMesh.primitives[ 0 ];

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Create Geometry + Skinned Mesh
    let geo     = new THREE.BufferGeometry();
    geo.setIndex( new THREE.BufferAttribute( tfPrim.indices.data, 1 ) );
    geo.setAttribute( 'position',   new THREE.BufferAttribute( tfPrim.position.data, tfPrim.position.componentLen ) );
    geo.setAttribute( 'normal',     new THREE.BufferAttribute( tfPrim.normal.data, tfPrim.normal.componentLen ) );
    geo.setAttribute( 'skinIndex',  new THREE.BufferAttribute( tfPrim.joints_0.data, tfPrim.joints_0.componentLen ) );
    geo.setAttribute( 'skinWeight', new THREE.BufferAttribute( tfPrim.weights_0.data, tfPrim.weights_0.componentLen ) );

    let mesh    = new THREE.SkinnedMesh( geo, new THREE.MeshPhongMaterial() );
    App.add( mesh );

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Create Armature / Skeleton
    let bone, aryBones = new Array();
    for( const j of skin.joints ){
        bone        = new THREE.Bone();
        bone.name   = j.name.replace( "mixamorig:", "" );

        if( j.parentIndex != null ) aryBones[ j.parentIndex ].add( bone );
        if( j.scale )               bone.scale.fromArray( j.scale );
        if( j.position )            bone.position.fromArray( j.position );
        if( j.rotation )            bone.quaternion.fromArray( j.rotation );
        
        aryBones.push( bone );
    }

    let skeleton = new THREE.Skeleton( aryBones );
    mesh.add( aryBones[ 0 ] );  // Attach Root Bone to Mesh
    mesh.bind( skeleton );      // Generate BindPose

    let skelView = new THREE.SkeletonHelper( mesh );
    App.add( skelView );

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Test by rotating a few bones
    aryBones[ 44 ].rotation.x -= 90 * Math.PI / 180;
    aryBones[ 45 ].rotation.x -= 90 * Math.PI / 180;

});

</script></body></html>