<!DOCTYPE html><html><head><title></title></head><body><script type="module">

import Starter, { THREE }   from "../lib/starter.js";
import PointsMesh           from "../lib/PointsMesh.js";
import LinesMesh            from "../lib/LinesMesh.js";

import Mat4                 from "../../dist/Mat4.js";
import Vec3                 from "../../dist/Vec3.js";
import Ray                  from "../../dist/ray/Ray.js";

let App;
let ln, pnt;
let Data = {
    w    : 1.0,
    h    : 0.5,
    pos  : [ 0, 1.0, 0 ],    
};

window.addEventListener( "load", _=>{
    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    App = new Starter( { webgl2:false, grid:true } );
    App.set_camera( 0, 20, 6 ).render();

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    pnt = new PointsMesh( 50 );
    App.add( pnt.mesh );

    ln = new LinesMesh( 50 );
    App.add( ln.mesh );

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    const   v0 = Vec3.add( Data.pos, [-Data.w,  Data.h, 0] ),
            v1 = Vec3.add( Data.pos, [-Data.w, -Data.h, 0] ),
            v2 = Vec3.add( Data.pos, [ Data.w, -Data.h, 0] ),
            v3 = Vec3.add( Data.pos, [ Data.w,  Data.h, 0] );

    ln  .add( v0, v1, 0x00ff00, null, true )
        .add( v1, v2, 0x00ff00, null, true )
        .add( v2, v3, 0x00ff00, null, true )
        .add( v3, v0, 0x00ff00, null, true );
});

window.addEventListener( "pointerdown", e=>{
    if( e.button != 2 ) return;

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Grab Info that needed to Project the Mouse Position into the 3D Scene
    const proj  = new Mat4();
    const world = new Mat4();
    const size  = new THREE.Vector2();
    const x     = e.clientX;
    const y     = e.clientY;

    App.renderer.getSize( size );                   // Need Size of Canvas
    App.camera.projectionMatrix.toArray( proj );    // Need Projection Matrix
    App.camera.matrixWorld.toArray( world );        // World Space Transform of Camera

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Compute the Ray and visually draw a line
    const ray = new Ray();
    ray.fromScreenProjection( x, y, size.x, size.y, proj, world );
    ln.add( ray.origin, ray.end, 0x00ffff );

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    let t;
    if( (t = ray.inQuad( Data.pos, Data.w, Data.h )) != null ){
        pnt.add( ray.posAt( t ), 0x00ffff, 4 );
    }
} );

</script></body></html>