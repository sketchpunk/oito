<!DOCTYPE html><html><head><title></title></head><body><script type="module">

import Starter, { THREE }   from "../lib/starter.js";
import PointsMesh           from "../lib/PointsMesh.js";
import LinesMesh            from "../lib/LinesMesh.js";

import Mat4                 from "../../dist/Mat4.js";
import Vec3                 from "../../dist/Vec3.js";
import Ray                  from "../../dist/ray/Ray.js";

let App;
let ln, pnt;
let Data = {
    posA  : [ -1, 1.0, 0 ],
    posB  : [ 1.0, 0.1, -0.5 ],
};

window.addEventListener( "load", _=>{
    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    App = new Starter( { webgl2:false, grid:true } );
    App.set_camera( 0, 20, 6 ).render();

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    pnt = new PointsMesh( 50 );
    App.add( pnt.mesh );

    ln = new LinesMesh( 50 );
    App.add( ln.mesh );

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ln.add( Data.posA, Data.posB, 0x00ff00 );
});

window.addEventListener( "pointerdown", e=>{
    if( e.button != 2 ) return;

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Grab Info that needed to Project the Mouse Position into the 3D Scene
    const proj  = new Mat4();
    const world = new Mat4();
    const size  = new THREE.Vector2();
    const x     = e.clientX;
    const y     = e.clientY;

    App.renderer.getSize( size );                   // Need Size of Canvas
    App.camera.projectionMatrix.toArray( proj );    // Need Projection Matrix
    App.camera.matrixWorld.toArray( world );        // World Space Transform of Camera

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Compute the Ray and visually draw a line
    const ray = new Ray();
    ray.fromScreenProjection( x, y, size.x, size.y, proj, world );
    ln.add( ray.origin, ray.end, 0x00ffff );

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    let tAry;
    if( (tAry = ray.nearSegment( Data.posA, Data.posB )) != null ){
        let rPos = ray.posAt( tAry[ 1 ] );
        let sPos = Vec3.lerp( Data.posA, Data.posB, tAry[ 0 ] );
        pnt.add( rPos, 0x00ffff, 2 );
        pnt.add( sPos, 0x00ff00, 2 );
        ln.add( rPos, sPos, 0x00ffff, 0x00ff00 );
    }
} );

</script></body></html>